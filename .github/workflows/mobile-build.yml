name: mobile - Build APK

on:
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    environment: production # prod 環境変数 
    defaults:
      run:
        working-directory: ./mobile

    permissions:
      contents: read # ビルドするだけなのでreadで十分

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ./mobile/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        run: npm install -g eas-cli

      - name: Extract Release Info
        id: extract_info
        run: |
          # バージョンとリリースノートを抽出
          NATIVE_VER=$(jq -r '.versions[0].nativeVersion' versions.json)
          NOTES=$(jq -r '.versions[0].updates[] | "- " + .date + ": " + .message' versions.json)
          
          # 環境変数にセット (ビルドステップ用)
          echo "NATIVE_VER=$NATIVE_VER" >> $GITHUB_ENV
          
          # 次のワークフローに渡すためにファイルに保存
          mkdir -p build_assets
          echo "$NATIVE_VER" > build_assets/version.txt
          
          # リリース本文を作成してファイルに保存
          echo "## Ver $NATIVE_VER" > build_assets/body.txt
          echo "" >> build_assets/body.txt
          echo "### Updates in this version" >> build_assets/body.txt
          echo "$NOTES" >> build_assets/body.txt
          echo "" >> build_assets/body.txt
          echo "Built at: $(date +'%Y-%m-%d')" >> build_assets/body.txt

      - name: Build APK with EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_VERSION: ${{ env.NATIVE_VER }}

          EXPO_PUBLIC_DISCORD_WEBHOOK_URL: ${{ secrets.EXPO_PUBLIC_DISCORD_WEBHOOK_URL }}
        
        run: eas build --platform android --profile prod-apk --non-interactive --local --output "./build_assets/vrcp-${{ env.NATIVE_VER }}.apk"

      # APKとメタデータ(バージョン情報など)をアーティファクトとしてアップロード
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mobile-build-artifacts
          path: ./mobile/build_assets/
          retention-days: 3 # 確認用なので保存期間は短めでOK