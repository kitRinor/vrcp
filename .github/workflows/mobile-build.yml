name: mobile - Build APK

on:
  workflow_dispatch:
    inputs:
      build_platform:
        description: 'EAS Build Target Platform'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
      build_profile:
        description: 'EAS Build Profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production
          - prod-apk

jobs:
  build:
    name: Build APK
    runs-on: ${{ inputs.build_platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}
    environment: ${{ (inputs.build_profile == 'production' || inputs.build_profile == 'prod-apk') && 'production' || 'development' }} 
    defaults:
      run:
        working-directory: ./mobile

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ./mobile/package-lock.json

      # Install Java for Android builds
      - name: Setup Java
        if: inputs.build_platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Cache CocoaPods for iOS builds
      - name: Cache CocoaPods
        if: inputs.build_platform == 'ios'
        uses: actions/cache@v3
        with:
          path: ./mobile/ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('mobile/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        run: npm install -g eas-cli

      - name: Extract Build Info
        id: extract_info
        run: |
          PROFILE="${{ inputs.build_profile }}"
          
          # get envs from eas.json and save to eas_env file
          jq -r ".build[\"$PROFILE\"].env // {} | to_entries[] | .key + \"=\" + (.value | tostring)" eas.json > .eas_env
          
          # export all envs on eas_env file
          while IFS='=' read -r key value; do
            export "$key=$value"
            echo "Exported: $key"
          done < .eas_env
          rm .eas_env

          # Generate app config to get app info
          APP_CONFIG=$(npx expo config --json --non-interactive)
          
          NATIVE_VER=$(echo "$APP_CONFIG" | jq -r '.version')
          
          # set to env for build steps
          echo "NATIVE_VER=$NATIVE_VER" >> $GITHUB_ENV
          
          # 次のワークフローに渡すためにファイルに保存
          mkdir -p build_assets
          echo "$NATIVE_VER" > build_assets/version.txt

      - name: Determine File Extension
        id: ext
        run: |
          PLATFORM="${{ inputs.build_platform }}"
          PROFILE="${{ inputs.build_profile }}"
          EXT=""
          SUFFIX=""
          
          if  [ "$PROFILE" == "development" ]; then
            SUFFIX="-dev"
          elif [ "$PROFILE" == "preview" ]; then
            SUFFIX="-pre"
          else
            SUFFIX=""
          fi
  
          if [ "$PLATFORM" == "android" ]; then
            if [ "$PROFILE" == "production" ]; then
              # Android:production => aab
              EXT="aab"
            else
              # Android:other => apk
              EXT="apk"
            fi
          elif [ "$PLATFORM" == "ios" ]; then
             # iOS => ipa
             EXT="ipa"
          fi

          echo "Target Extension: .$EXT"
          echo "FILE_EXT=$EXT" >> $GITHUB_ENV
          echo "FILE_SUFFIX=$SUFFIX" >> $GITHUB_ENV

      - name: Build App with EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_VERSION: ${{ env.NATIVE_VER }}

          EXPO_PUBLIC_DISCORD_WEBHOOK_URL: ${{ secrets.EXPO_PUBLIC_DISCORD_WEBHOOK_URL }}
        
        run: |
          eas build \
          --platform ${{ inputs.build_platform }} \
          --profile ${{ inputs.build_profile }} \
          --non-interactive \
          --local \
          --output "./build_assets/vrcp-${{ env.NATIVE_VER }}${{ env.FILE_SUFFIX }}.${{ env.FILE_EXT }}"

      # APKとメタデータ(バージョン情報など)をアーティファクトとしてアップロード
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mobile-build-artifacts
          path: ./mobile/build_assets/
          retention-days: 3 # 確認用なので保存期間は短めでOK