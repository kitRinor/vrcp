name: mobile - Build APK

on:
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile

    permissions:
      contents: read # ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã ã‘ãªã®ã§readã§ååˆ†

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ./mobile/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        run: npm install -g eas-cli

      - name: Extract Release Info
        id: extract_info
        run: |
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æŠ½å‡º
          NATIVE_VER=$(jq -r '.versions[0].nativeVersion' versions.json)
          NOTES=$(jq -r '.versions[0].updates[] | "- " + .date + ": " + .message' versions.json)
          
          # ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ (ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ç”¨)
          echo "NATIVE_VER=$NATIVE_VER" >> $GITHUB_ENV
          
          # æ¬¡ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«æ¸¡ã™ãŸã‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          mkdir -p build_assets
          echo "$NATIVE_VER" > build_assets/version.txt
          
          # ãƒªãƒªãƒ¼ã‚¹æœ¬æ–‡ã‚’ä½œæˆã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "## Ver $NATIVE_VER" > build_assets/body.txt
          echo "" >> build_assets/body.txt
          echo "### Updates in this version" >> build_assets/body.txt
          echo "$NOTES" >> build_assets/body.txt
          echo "" >> build_assets/body.txt
          echo "ğŸ“… Built at: $(date +'%Y-%m-%d')" >> build_assets/body.txt

      - name: Build APK with EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_VERSION: ${{ env.NATIVE_VER }}
        run: |
          FILENAME="vrcp-${{ env.NATIVE_VER }}.apk"
          # APKã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ build_assets ãƒ•ã‚©ãƒ«ãƒ€ã«å‡ºåŠ›
          eas build --platform android --profile prod-apk --non-interactive --local --output "./build_assets/$FILENAME"

      # APKã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿(ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãªã©)ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mobile-build-artifacts
          path: ./mobile/build_assets/
          retention-days: 3 # ç¢ºèªç”¨ãªã®ã§ä¿å­˜æœŸé–“ã¯çŸ­ã‚ã§OK